import os from 'os';
import etag from 'etag';
<<<<<<< HEAD
import { parse } from 'url';
import { copySync, existsSync } from 'fs-extra';
import { join, dirname, basename } from 'path';
=======
import { join } from 'path';
import { copySync, existsSync } from 'fs-extra';
import { getPageName } from './utils';
>>>>>>> e700a9c4c717f14b8cdf29aee9cd1d442a8ad44a

const TMP_DATA_PATH = join(os.tmpdir(), 'data/datastore');
const CUR_DATA_PATH = join(__dirname, '.cache/data/datastore');

if (!existsSync(TMP_DATA_PATH)) {
  // Copies executable `data` files to the writable /tmp directory.
  copySync(CUR_DATA_PATH, TMP_DATA_PATH);
}

async function getGraphQLEngine() {
  const { GraphQLEngine } = await import(
    join(__dirname, '.cache/query-engine/index.js')
  );

  return new GraphQLEngine({ dbPath: TMP_DATA_PATH });
}

async function getPageSSRHelpers() {
  return await import(join(__dirname, '.cache/page-ssr/index.js'));
}

export default async function handler(req, res) {
<<<<<<< HEAD
  let pageName;
  const pathname = parse(req.url).pathname || '/';
  const isPageData = pathname.startsWith('/page-data/');
  if (isPageData) {
    // /page-data/index/page-data.json
    // /page-data/using-ssr/page-data.json
    pageName = basename(dirname(pathname));
    if (pageName === 'index') {
      pageName = '/';
    }
  } else {
    // /using-ssr
    // /using-ssr/
    // /using-ssr/index.html
    pageName = basename(pathname);
    if (pageName === 'index.html') {
      pageName = basename(dirname(pathname));
    }
    if (!pageName) {
      pageName = '/';
    }
  }
=======
  // eslint-disable-next-line no-undef
  const { pathName, isPageData } = getPageName(req.url, vercel_pathPrefix);
>>>>>>> e700a9c4c717f14b8cdf29aee9cd1d442a8ad44a

  const [graphqlEngine, { getData, renderHTML, renderPageData }] =
    await Promise.all([getGraphQLEngine(), getPageSSRHelpers()]);

  const data = await getData({
<<<<<<< HEAD
    pathName: pageName,
=======
    pathName,
>>>>>>> e700a9c4c717f14b8cdf29aee9cd1d442a8ad44a
    graphqlEngine,
    req,
  });

  const results = isPageData
    ? await renderPageData({ data })
    : await renderHTML({ data });

  if (data.serverDataHeaders) {
    for (const [name, value] of Object.entries(data.serverDataHeaders)) {
      res.setHeader(name, value);
    }
  }

  if (data.serverDataStatus) {
    res.statusCode = data.serverDataStatus;
  }

  if (isPageData) {
    res.setHeader('ETag', etag(JSON.stringify(results)));
    res.json(results);
  } else {
    res.send(results);
  }
}
